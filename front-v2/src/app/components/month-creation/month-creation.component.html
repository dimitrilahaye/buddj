<app-modal
  [modalOpen]="yearlyOutflowDelationModalIsOpen"
  (click)="closeYearlyOutflowDelationModal($event)"
>
  <app-button
    [size]="'big'"
    [variant]="'danger'"
    [label]="'Supprimer la sortie d√©finitivement'"
    [loading]="removeIsLoading"
    (click)="removeYearlyOutflow($event)"
  ></app-button>
</app-modal>
<app-modal
  [modalOpen]="pendingDebitDelationModalIsOpen"
  (click)="closePendingDebitDelationModal($event)"
>
  <app-button
    [size]="'big'"
    [variant]="'danger'"
    [label]="'Supprimer la sortie d√©finitivement'"
    [loading]="removeIsLoading"
    (click)="removePendingDebit($event)"
  ></app-button>
</app-modal>
@if(!dataLoaded) {
<app-loader></app-loader>
} @if(template === null) {

<app-header-back-button></app-header-back-button>
<div class="tips-container">
  <app-tips>
    <p>Vous n'avez pas encore cr√©e de template par d√©faut üôÇ</p>
    <img width="50%" src="info/no-default-template.png" alt="" />
    <app-button-link (onClick)="goToTemplatesPage()"
      >Se rendre sur la page de gestion des templates</app-button-link
    >
  </app-tips>
</div>

} @if(dataLoaded && form) {
<app-header-back-button></app-header-back-button>
<form class="month-creation" [formGroup]="form">
  <!-- 
    ##################### STEP 1 #####################
     -->
  <div class="month-creation__step month-creation__step--step1">
    <!-- month date -->
    <app-input-month
      [formGroup]="form"
      formControlName="month"
      [required]="true"
      [placeholder]="'Mois'"
      [min]="(newMonth.month | date : 'yyyy-MM') || ''"
    ></app-input-month>
    <!-- month starting balance -->
    <app-input-number
      [formGroup]="form"
      (click)="openNumpad(form.controls['startingBalance'])"
      formControlName="startingBalance"
      [required]="true"
      [placeholder]="'Solde initial'"
      [step]="'0.01'"
    ></app-input-number>
  </div>

  <app-divider></app-divider>

  <!-- 
  ##################### STEP 2 #####################
   -->

  <!-- 
  ##################### YEARLY OUTFLOWS #####################
   -->
  @if (yearlyOutflowsControls.controls.length > 0) {
  <div
    class="month-creation__step month-creation__step--step_debits"
    formArrayName="yearlyOutflows"
  >
    <div class="month-creation-step__info">
      Voici les sorties annuelles qui concernent le mois s√©lectionn√©
      <br />
      <span class="month-creation-step-info__total">
        Total : {{ getYearlyOutflowsTotal() | currency : "EUR" }}
      </span>
      <br />
      <app-button-link
        (onClick)="toggleYearlyOutflows()"
        class="month-creation-step-info__link"
      >
        @if(takeIntoAccountYearlyOutflows) { Ne pas les prendre en compte dans
        le solde pr√©visionnel } @else { Les prendre en compte dans le solde
        pr√©visionnel }
      </app-button-link>
    </div>
    @if(takeIntoAccountYearlyOutflows) {
    <app-item
      *ngFor="let outflow of yearlyOutflowsControls.controls; let i = index"
      [formGroupName]="i"
    >
      <div class="month-creation-item">
        <span class="month-creation-item__icon">
          <i class="fa-solid fa-money-bill-transfer"></i>
        </span>
        <div class="month-creation-item__info">
          <span class="month-creation-item-info__label">{{
            outflow.get("label")?.value
          }}</span>
          <span class="month-creation-item-info__amount"
            >{{ outflow.get("amount")?.value }}‚Ç¨</span
          >
        </div>
        <button
          class="month-creation-item__delete"
          type="button"
          (click)="openYearlyOutflowDelationModal(i, $event)"
        >
          <i class="fa-solid fa-trash-can"></i>
        </button>
      </div>
    </app-item>
    }
  </div>
  }

  <!-- 
  ##################### PENDING DEBITS #####################
   -->
  @if (pendingDebits.controls.length > 0) {
  <div
    class="month-creation__step month-creation__step--step_debits"
    formArrayName="pendingDebits"
  >
    <div class="month-creation-step__info">
      Voici les d√©penses des mois pr√©c√©dents qui n'ont pas encore √©t√© pr√©lev√©es.
      <br />
      <span class="month-creation-step-info__total">
        Total : {{ getPendingDebitsTotal() | currency : "EUR" }}
      </span>
      <br />
      <app-button-link
        (onClick)="togglePendingDebits()"
        class="month-creation-step-info__link"
      >
        @if(takeIntoAccountPendingDebits) { Ne pas les prendre en compte dans le
        solde pr√©visionnel } @else { Les prendre en compte dans le solde
        pr√©visionnel }
      </app-button-link>
    </div>
    @if(takeIntoAccountPendingDebits) {
    <app-item
      *ngFor="let debit of pendingDebits.controls; let i = index"
      [formGroupName]="i"
    >
      <div class="month-creation-item">
        <span class="month-creation-item__icon">
          <i class="fa-solid fa-money-bill-transfer"></i>
        </span>
        <div class="month-creation-item__info">
          <span class="month-creation-item-info__label">{{
            debit.get("label")?.value
          }}</span>
          <span class="month-creation-item-info__amount"
            >{{ debit.get("amount")?.value }}‚Ç¨</span
          >
        </div>
        <button
          class="month-creation-item__delete"
          type="button"
          (click)="openPendingDebitDelationModal(i, $event)"
        >
          <i class="fa-solid fa-trash-can"></i>
        </button>
      </div>
    </app-item>
    }
  </div>
  }
  <div
    class="month-creation__step month-creation__step--step2"
    formArrayName="outflows"
  >
    <div class="month-creation-step__add-outflow">
      <app-button
        (click)="addNewOutflow($event)"
        [size]="'big'"
        [label]="'Ajouter une sortie mensuelle'"
      ></app-button>
    </div>
    <app-item
      *ngFor="let outflow of outflows.controls; let i = index"
      [formGroupName]="i"
    >
      <div class="month-creation-item">
        <span class="month-creation-item__icon">
          <i class="fa-solid fa-money-bill-transfer"></i>
        </span>
        <div class="month-creation-item__info">
          <span class="month-creation-item-info__label">{{
            outflow.get("label")?.value
          }}</span>
          <span class="month-creation-item-info__amount"
            >{{ outflow.get("amount")?.value }}‚Ç¨</span
          >
        </div>

        <app-toggle-visibility-button
          [index]="i"
          (clicked)="toggleVisibilityForOutflowWithIndex(i)"
        ></app-toggle-visibility-button>
        <button
          class="month-creation-item__edit"
          type="button"
          (click)="openOutflowsModal(i, $event)"
        >
          <i class="fa-solid fa-pen-fancy"></i>
        </button>
      </div>
    </app-item>
  </div>

  <app-divider></app-divider>

  <!-- 
  ##################### STEP 3 #####################
   -->

  <div
    class="month-creation__step month-creation__step--step3"
    formArrayName="weeklyBudgets"
  >
    <app-item
      *ngFor="let weeklyBudget of weeklyBudgets.controls; let i = index"
      [formGroupName]="i"
    >
      <div class="month-creation-item">
        <span class="month-creation-item__icon">
          <i class="fa-solid fa-basket-shopping"></i>
        </span>
        <div class="month-creation-item__info">
          <span class="month-creation-item-info__label">{{
            weeklyBudget.get("name")?.value
          }}</span>
          <span class="month-creation-item-info__amount"
            >{{ weeklyBudget.get("initialBalance")?.value }}‚Ç¨</span
          >
        </div>

        <button
          class="month-creation-item__edit"
          type="button"
          (click)="openWeeklyBudgetsModal(i, $event)"
        >
          <i class="fa-solid fa-pen-fancy"></i>
        </button>
      </div>
    </app-item>
  </div>
</form>
<div class="month-creation__footer">
  <span class="month-creation-footer__forecast-balance"
    >Solde pr√©visionnel : <strong>{{ forecastBalance }}‚Ç¨</strong></span
  >
  <div class="month-creation-footer__actions">
    <button
      class="month-creation-footer-actions__action"
      type="button"
      (click)="addNewOutflow($event)"
    >
      <i class="fa-solid fa-plus"></i>
    </button>
    <button
      class="month-creation-footer-actions__action"
      type="button"
      (click)="resetForm($event)"
    >
      <i class="fa-solid fa-rotate"></i>
    </button>
    <app-button
      [type]="'submit'"
      [size]="'big'"
      [variant]="'danger'"
      [label]="'Cr√©er'"
      [loading]="creationLoader"
      (click)="onSubmit($event)"
    ></app-button>
  </div>
</div>

<!-- 
  ##################### Modal outflows (step 2) #####################
   -->

@if(outflowsFormGroup !== undefined) {
<app-sliding-modal
  [isOpen]="isOutflowsModalOpen"
  (close)="closeOutflowsModal()"
>
  <form [formGroup]="outflowsFormGroup" (ngSubmit)="submitOutflowModal($event)">
    <div class="modal-container">
      <!-- label -->
      <app-input-text
        [formGroup]="outflowsFormGroup"
        formControlName="label"
        [required]="true"
      ></app-input-text>

      <!-- amount -->
      <app-input-number
        (click)="openNumpad(outflowsFormGroup.controls['amount'])"
        [formGroup]="outflowsFormGroup"
        formControlName="amount"
        [required]="true"
        [step]="'0.01'"
      ></app-input-number>

      <div class="modal-container__actions">
        <app-button
          class="login-page__login-button"
          [label]="'Supprimer'"
          [variant]="'danger'"
          (click)="deleteOutflow($event)"
        ></app-button>
        <app-button
          class="login-page__login-button"
          [type]="'submit'"
          [label]="'Modifier'"
        ></app-button>
      </div>
    </div>
  </form>
</app-sliding-modal>
}

<!-- 
  ##################### Modal weekly budgets (step 3) #####################
   -->

@if(weeklyBudgetsFormGroup !== undefined) {
<app-sliding-modal
  [isOpen]="isWeeklyBudgetsModalOpen"
  (close)="closeWeeklyBudgetsModal()"
>
  <form
    [formGroup]="weeklyBudgetsFormGroup"
    (ngSubmit)="submitWeeklyBudgetModal($event)"
  >
    <div class="modal-container">
      <!-- name -->
      <app-input-text
        [formGroup]="weeklyBudgetsFormGroup"
        formControlName="name"
        [required]="true"
      ></app-input-text>

      <!-- initial balance -->
      <app-input-number
        (click)="openNumpad(weeklyBudgetsFormGroup.controls['initialBalance'])"
        [formGroup]="weeklyBudgetsFormGroup"
        formControlName="initialBalance"
        [required]="true"
        [step]="'0.01'"
      ></app-input-number>

      <div class="modal-container__actions">
        <app-button
          class="login-page__login-button"
          [type]="'submit'"
          [label]="'Modifier'"
        ></app-button>
      </div>
    </div>
  </form>
</app-sliding-modal>
}

<!-- 
  ##################### NUMPAD #####################
   -->

@if(amountValueControl !== null) {
<app-sliding-modal [isOpen]="isNumpadModalOpen" (close)="closeNumpad($event)">
  <app-numpad
    [value]="amountValue"
    (submitted)="updateAmountValue($event)"
  ></app-numpad>
</app-sliding-modal>
} }
